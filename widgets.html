<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=10">
    <title>Тестовые виджеты</title>    
    <link rel="stylesheet" href="css/widgets.css">
	<script src="https://yookassa.ru/checkout-widget/v1/checkout-widget.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="img/favicon.ico" type="image/x-icon">
</head>
<body style="font-family: 'Source Sans Pro', sans-serif">
    <div class="content-wrapper">
        <header class="header">
            <p style="font-size: 30px; margin: 0; padding: 10px;" id="logo" class="logo" title="Документация">Тестовые виджеты</p>
            <!--<div class="text-field">
                <label class="text-field__label" for="search">Confirmation Token</label>
                <div class="text-field__group">
                    <button class="text-field__btnl" type="button" id="logs" name="logs-btn">Kibana frontend</button>
                    <input class="text-field__input" type="search" id="search" name="search" size="50">
                    <button class="text-field__btn" type="button" id="render" name="render">Отрисовать</button>
                </div>
            </div>-->
        </header>

        <div class="container clearfix">
            <div id="settings-form" class="widget-container" style="width: 55%; padding-left: 15px;">
                <br>
                <fieldset>
                    <legend>Confirmation Token</legend>
                    <div class="text-field">
                        <!--<label class="text-field__label" for="conftoken">Confirmation Token</label>-->
                        <div class="text-field__group">
                            <!--<button class="text-field__btnl" type="button" id="logs" name="logs-btn">Kibana frontend</button>-->
                            <input class="text-field__input" type="conftoken" id="conftoken" name="conftoken" size="50">
                            <input type="checkbox" id="ismodal" name="ismodal" value="ismodal"><label for="ismodal">Модальное окно</label>
                        </div>
                    </div>               
                </fieldset>
                <fieldset>
                    <legend>Все цвета кастомизации в формате HTML: #000000 - #FFFFFF</legend>
                    <div class="text-field">
                        <div class="text-field__group">             
                            <input class="text-field__input" type="background" id="background" name="background" size="5">
                            <label class="text-field__label" for="background" style="padding-left: 5px">Background (Цвет фона платежной формы)</label>
                        </div> 
                    </div>
                    <div class="text-field">
                        <div class="text-field__group" style="padding-top: 5px">             
                            <input class="text-field__input" type="controlPrimary" id="controlPrimary" name="controlPrimary" size="5">
                            <label class="text-field__label" for="controlPrimary" style="padding-left: 5px">controlPrimary (Цвет кнопки Заплатить и других акцентных элементов)</label>
                        </div> 
                    </div>
                    <div class="text-field">
                        <div class="text-field__group" style="padding-top: 5px">             
                            <input class="text-field__input" type="controlPrimaryContent" id="controlPrimaryContent" name="controlPrimaryContent" size="5">
                            <label class="text-field__label" for="controlPrimaryContent" style="padding-left: 5px">controlPrimaryContent (Цвет текста кнопки Заплатить)</label>
                        </div> 
                    </div>
                    <div class="text-field">
                        <div class="text-field__group" style="padding-top: 5px">             
                            <input class="text-field__input" type="controlSecondary" id="controlSecondary" name="controlSecondary" size="5">
                            <label class="text-field__label" for="controlSecondary" style="padding-left: 5px">controlSecondary (Цвет неакцентных элементов интерфейса)</label>
                        </div> 
                    </div>  
                    <div class="text-field">
                        <div class="text-field__group" style="padding-top: 5px">             
                            <input class="text-field__input" type="border" id="border" name="border" size="5">
                            <label class="text-field__label" for="border" style="padding-left: 5px">border (Цвет границ и разделителей)</label>
                        </div> 
                    </div> 
                    <div class="text-field">
                        <div class="text-field__group" style="padding-top: 5px">             
                            <input class="text-field__input" type="text" id="text" name="text" size="5">
                            <label class="text-field__label" for="text" style="padding-left: 5px">text (Цвет текста)</label>
                        </div> 
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Тип виджета:</legend>
                    <div>
                        <input type="radio" id="all-methods" name="method" value="all" checked><label for="all-methods">Все способы</label>
                        <input type="radio" id="card-method" name="method" value="card"><label for="card-method">Банковская карта</label>
                        <input type="radio" id="sber-method" name="method" value="sber"><label for="sber-method">SberPay</label>
                        <input type="radio" id="yoo-method" name="method" value="yoo"><label for="yoo-method">Кошелек ЮMoney</label>
                        <input type="radio" id="sbp-method" name="method" value="sbp"><label for="sbp-method">СБП</label>
                        <p>Чтобы форсировать конкретный способ, проверяйте на шопе доступность способа и параметр:<textarea id="shopParams" style="width:100%; height: 70%;font-family: 'Source Sans Pro', sans-serif; resize: none;" readonly><parameter key="shopSettings.clientSettings.widget.allowRenderSelectedPaymentOptions" value="true"/></textarea></p>
                    </div>
                </fieldset>                
                <button class="text-field__btn" type="button" id="render" name="render">Отрисовать</button>
                <button class="text-field__btn" type="button" id="dwnld" name="html">Скачать HTML</button> 
                <button class="text-field__btn" type="button" id="logs" name="logs">Kibana frontend</button>
                <div class="text-field">
                    <label class="text-field__label" for="search">shopID</label>
                    <div class="text-field__group">
                        <input class="text-field__input" type="shop" id="shop" name="shopik" size="5">
                        <button class="text-field__btn" type="button" id="go" name="render">АРМ ШМ</button>
                    </div>
                </div>
            </div>
            <div class="widget-container" style="width: 55%;">
                <br><fieldset style="height:550px">
                    <legend>Виджет:</legend>
                    <div id="render-form" class="widget-container"></div>
                </fieldset>
                <!--<fieldset style="height: 30%;">
                    <legend>Код готовой страницы:</legend>
                    <textarea id="wdg_code" style="width:100%; height:77%; font-family:Script; resize: none;" readonly>Код готовой страницы появится после отрисовки</textarea>
                    <button class="text-field__btnl" type="button" id="dwnld" name="html">Скачать HTML</button>                    
                </fieldset>-->
            </div>
        </div> 
    </div>
	<script>
        document.getElementById("background").value = "#";
        document.getElementById("controlPrimary").value = "#";
        document.getElementById("controlPrimaryContent").value = "#";
        document.getElementById("controlSecondary").value = "#";
        document.getElementById("border").value = "#";
        document.getElementById("text").value = "#";
        rendered = false;
        token = '';	
        cust_colors = { // default
        };
        render_request = {
            confirmation_token: token, 
            return_url: 'http://kiacode.space/return_url',
            customization: {
                colors: cust_colors
            },
            error_callback: function(error) {
                console.log(error)
            }
        };
        
        function download(text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', 'WidgetYookassa.html');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }        
        document.querySelector("#dwnld").onclick = function() {
            //if(token.substring(0,2) == "ct" && document.getElementById("wdg_code").value != "Скачать страницу можно будет после отрисовки") download(generateHTML());
            if(token.substring(0,2) == "ct") download(generateHTML());
            else alert('Введите confirmation token');            
        }
        document.querySelector("#logo").onclick = function() {
            window.location.href = "https://yookassa.ru/developers/payment-acceptance/integration-scenarios/widget/quick-start"
        }
        document.querySelector("#go").onclick = function() {
            if(String(document.getElementById("shop").value).length > 0) window.open("https://arm.yooteam.ru/v3/shop-masters/shops?query="+document.getElementById("shop").value+"&shop=active");
            else window.open("https://arm.yooteam.ru/v3/shop-masters/shops");            
        }
        document.querySelector("#logs").onclick = function() {
            token = document.getElementById("conftoken").value; 
            if(token.substring(0,2) == "ct")
            { 
                window.open("https://kibana.yooteam.ru/app/kibana#/discover?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-1d,to:now))&_a=(columns:!(Payload,message.message),filters:!(),index:'frontend-checkout-client-main-*',interval:auto,query:(language:lucene,query:'Payload:%20(%20%22"+token+"%22%20%22ДопТрейс%22%20)'),sort:!())");
            }
            else alert('Введите confirmation token!');
        }
        function checkcolor(color) {
            if(color.substring(0,1) == "#") return true;
            else return false;
        }
        function generateHTML() {            
            code = '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">';
            code += '\n<html>';
            code += '\n\t<head>';
            code += '\n\t<meta http-equiv="Content-Type" content="text/html; charset=utf-8">';
            code += '\n\t<title>❤ KiaCode</title>';
            code += '\n\t<!--Подключение библиотеки для инициализации виджета ЮKassa-->';
            code += '\n\t<script src="https://yookassa.ru/checkout-widget/v1/checkout-widget.js">';
            code += '</scr';
            code += 'ipt>'
            code += '\n\t</head>';
            code += '\n\t<body>';
            code += '\n\t\t<p>Ниже отобразится платежная форма. Если вы еще не создавали платеж и не передавали токен для инициализации виджета, появится сообщение об ошибке.</p>';
            code += '\n\t\t<!--Контейнер, в котором будет отображаться платежная форма-->';
            code += '\n\t\t<div id="payment-form"></div>';
            code += '\n\t\t<p>Данные банковской карты для оплаты в <b>тестовом магазине</b>:</p>';
            code += '\n\t\t<ul>';
            code += '\n\t\t\t<li>номер — <b>5555 5555 5555 4477</b></li>';
            code += '\n\t\t\t<li>срок действия — <b>01/30</b> (или другая дата, больше текущей)</li>';
            code += '\n\t\t\t<li>CVC — <b>123</b> (или три любые цифры)</li>';
            code += '\n\t\t\t<li>код для прохождения 3-D Secure — <b>123</b> (или три любые цифры)</li>';
            code += '\n\t\t</ul>';
            code += '\n\t\t<p><a href=https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing#test-bank-card>Другие тестовые банковские карты</a></p>';
            code += '\n\t\t<script>';
            code += '\n\t\t//Инициализация виджета. Все параметры обязательные.';
            code += '\n\t\tconst checkout = new window.YooMoneyCheckoutWidget({';
            code += '\n\t\t\tconfirmation_token: \''+token;
            code += '\',\n\t\t\treturn_url: \'https://example.com/\',';
            code += '\n\t\t\tcustomization: {';
            if(document.getElementById("ismodal").checked)
            {
                code += '\n\t\t\t\tmodal: true,';
            } 
            code += '\n\t\t\t\tcolors: {';
            if(checkcolor(String(document.getElementById("background").value))) background = String(document.getElementById("background").value);
            if(checkcolor(String(document.getElementById("controlPrimary").value))) controlPrimary = String(document.getElementById("controlPrimary").value);
            if(checkcolor(String(document.getElementById("controlPrimaryContent").value))) controlPrimaryContent = String(document.getElementById("controlPrimaryContent").value);
            if(checkcolor(String(document.getElementById("controlSecondary").value))) controlSecondary = String(document.getElementById("controlSecondary").value);
            if(checkcolor(String(document.getElementById("border").value))) border = String(document.getElementById("border").value);
            if(checkcolor(String(document.getElementById("text").value))) text = String(document.getElementById("text").value);
            hasPrev = false;
            if(background.length > 1) { code += '\n\t\t\t\t\tbackground: \''+cust_colors.background; hasPrev=true; }
            if(controlPrimary.length > 1) { if(hasPrev) {code+='\','} code += '\n\t\t\t\t\tcontrolPrimary: \''+cust_colors.controlPrimary; hasPrev=true; }
            if(controlPrimaryContent.length > 1) { if(hasPrev) {code+='\','} code += '\n\t\t\t\t\tcontrolPrimaryContent: \''+cust_colors.controlPrimaryContent; hasPrev=true; }
            if(controlSecondary.length > 1) { if(hasPrev) {code+='\','} code += '\n\t\t\t\t\tcontrolSecondary: \''+cust_colors.controlSecondary; hasPrev=true; }
            if(border.length > 1) { if(hasPrev) {code+='\','} code += '\n\t\t\t\t\tborder: \''+cust_colors.border; hasPrev=true; }
            if(text.length > 1)  { if(hasPrev) {code+='\','} code += '\n\t\t\t\t\ttext: \''+cust_colors.text; hasPrev=true; }
            if(hasPrev) {code+='\''}
            code += '\n\t\t\t\t}';
            if(document.getElementById("card-method").checked) code += ',\n\t\t\t\tpayment_methods: [\'bank_card\']';
            else if(document.getElementById("sber-method").checked) code += ',\n\t\t\t\tpayment_methods: [\'sberbank\']';
            else if(document.getElementById("yoo-method").checked) code += ',\n\t\t\t\tpayment_methods: [\'yoo_money\']';
            else if(document.getElementById("sbp-method").checked) code += ',\n\t\t\t\tpayment_methods: [\'sbp\']';
            code += '\n\t\t\t},';
            code += '\n\t\t\terror_callback: function(error) {';
            code += '\n\t\t\t\tconsole.log(error)';
            code += '\n\t\t\t}';
            code += '\n\t\t});';
            code += '\n\t\t//Отображение платежной формы в контейнере';
            code += '\n\t\tcheckout.render(\'payment-form\');';
            code += '\n\t</scr';
            code += 'ipt>';
            code += '\n</body>';
            code += '\n</html>';
            return String(code);
        }
        document.querySelector("#render").onclick = function(){
            token = document.getElementById("conftoken").value;            
            if(token.substring(0,2) == "ct")
            {   
                if(rendered)
                {
                    wdget.destroy();
                    rendered = false;
                    cust_colors = { };
                }
                if(checkcolor(String(document.getElementById("background").value))) background = String(document.getElementById("background").value); else background = '#';
                if(checkcolor(String(document.getElementById("controlPrimary").value))) controlPrimary = String(document.getElementById("controlPrimary").value); else controlPrimary = '#';
                if(checkcolor(String(document.getElementById("controlPrimaryContent").value))) controlPrimaryContent = String(document.getElementById("controlPrimaryContent").value); else controlPrimaryContent = '#';
                if(checkcolor(String(document.getElementById("controlSecondary").value))) controlSecondary = String(document.getElementById("controlSecondary").value); else controlSecondary = '#';
                if(checkcolor(String(document.getElementById("border").value))) border = String(document.getElementById("border").value); else border = '#';
                if(checkcolor(String(document.getElementById("text").value))) text = String(document.getElementById("text").value); else text = '#';
                
                if(background.length > 1) cust_colors.background = background;
                if(controlPrimary.length > 1) cust_colors.controlPrimary = controlPrimary;
                if(controlPrimaryContent.length > 1) cust_colors.controlPrimaryContent = controlPrimaryContent;
                if(controlSecondary.length > 1) cust_colors.controlSecondary = controlSecondary;
                if(border.length > 1) cust_colors.border = border;
                if(text.length > 1) cust_colors.text = text;
                if(document.getElementById("card-method").checked)
                {
                    render_request = {
                        confirmation_token: token, 
                        return_url: 'http://kiacode.space/return_url',
                        customization: {
                            colors: cust_colors,
                            payment_methods: ['bank_card']
                        },
                        error_callback: function(error) {
                            console.log(error)
                        }
                    }
                }
                else if(document.getElementById("sber-method").checked)
                {
                    render_request = {
                        confirmation_token: token, 
                        return_url: 'http://kiacode.space/return_url',
                        customization: {
                            colors: cust_colors,
                            payment_methods: ['sberbank']
                        },
                        error_callback: function(error) {
                            console.log(error)
                        }
                    }
                }
                else if(document.getElementById("yoo-method").checked)
                {
                    render_request = {
                        confirmation_token: token, 
                        return_url: 'http://kiacode.space/return_url',
                        customization: {
                            colors: cust_colors,
                            payment_methods: ['yoo_money']
                        },
                        error_callback: function(error) {
                            console.log(error)
                        }
                    }                    
                }
                else if(document.getElementById("sbp-method").checked)
                {
                    render_request = {
                        confirmation_token: token, 
                        return_url: 'http://kiacode.space/return_url',
                        customization: {
                            colors: cust_colors,
                            payment_methods: ['sbp']
                        },
                        error_callback: function(error) {
                            console.log(error)
                        }
                    }                    
                }
                else
                {                    
                    render_request = {
                        confirmation_token: token, 
                        return_url: 'http://kiacode.space/return_url',
                        customization: {
                            colors: cust_colors
                        },
                        error_callback: function(error) {
                            console.log(error)
                        }
                    }
                }
                if(document.getElementById("ismodal").checked)
                {
                    render_request.customization.modal = true;
                }              
                wdget = new window.YooMoneyCheckoutWidget(render_request);
                wdget.render('render-form');
                document.getElementById("wdg_code").value = generateHTML();
                rendered = true;
            }
            else {
                alert('Введите confirmation token');
            }
        }        
    </script>
</body>
</html>